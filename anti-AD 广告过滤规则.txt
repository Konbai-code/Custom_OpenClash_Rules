
(
    MAX_WAIT_TIME=30
    WAIT_INTERVAL=2
    elapsed_time=0

    while ! /etc/init.d/openclash status | grep -q "running"; do
        [ $elapsed_time -ge $MAX_WAIT_TIME ] && {
            LOG_OUT "[广告过滤规则] 超时未检测到 OpenClash 运行，退出..."
            exit 1
        }
        sleep $WAIT_INTERVAL
        elapsed_time=$((elapsed_time + WAIT_INTERVAL))
    done

    # 检查 dnsmasq 是否已准备好（目录存在 + 进程正在运行）
    D_WAIT=0
    while [ ! -d "/tmp/dnsmasq.d" ] && ! pgrep -f "dnsmasq" >/dev/null; do
        [ $D_WAIT -ge 10 ] && {
            LOG_OUT "[广告过滤规则] dnsmasq 未就绪，退出..."
            exit 1
        }
        sleep 1
        D_WAIT=$((D_WAIT + 1))
    done

    #LOG_OUT "[广告过滤规则] OpenClash 和 dnsmasq 已就绪，准备拉取规则..."

    # 自动获取 dnsmasq 配置目录
    HASH_ID=$(uci show dhcp.@dnsmasq[0] 2>/dev/null | grep -oE 'cfg[0-9a-f]{6}' | head -1)
    TARGET_DIR="/tmp/dnsmasq${HASH_ID:+.$HASH_ID}.d"
    [ ! -d "$TARGET_DIR" ] && TARGET_DIR="/tmp/dnsmasq.d"
    mkdir -p "$TARGET_DIR"

    #LOG_OUT "[广告过滤规则] 清理旧规则..."
    rm -f "$TARGET_DIR"/*ad*.conf 
    sed -i '/# AWAvenue-Ads-Rule Start/,/# AWAvenue-Ads-Rule End/d' /etc/hosts

    #LOG_OUT "[广告过滤规则] 拉取最新 anti-AD 规则..." 
    curl -sSL --retry 3 "https://gh-proxy.com/https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/adblock-for-dnsmasq.conf" \
        -o "$TARGET_DIR/anti-ad-for-dnsmasq.conf" || {
        LOG_OUT "[广告过滤规则] 拉取失败，请查看 /tmp/anti-ad-curl.log"
        exit 1
    }

    #LOG_OUT "[广告过滤规则] 拉取成功，重新加载 dnsmasq..."
    /etc/init.d/dnsmasq restart

    LOG_OUT "[广告过滤规则] 加载完成！"
) &
